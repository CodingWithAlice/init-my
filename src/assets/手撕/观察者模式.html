<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‹ä»¶ç³»ç»Ÿ</title>
</head>

<body>
    <div>
        è§‚å¯Ÿè€…æ¨¡å¼
        addListener(event, listener) ä¸ºæŒ‡å®šäº‹ä»¶æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ï¼Œé»˜è®¤æ·»åŠ åˆ°ç›‘å¬å™¨æ•°ç»„çš„å°¾éƒ¨ã€‚
        removeListener(event, listener) ç§»é™¤æŒ‡å®šäº‹ä»¶çš„æŸä¸ªç›‘å¬å™¨ï¼Œç›‘å¬å™¨å¿…é¡»æ˜¯è¯¥äº‹ä»¶å·²ç»æ³¨å†Œè¿‡çš„ç›‘å¬å™¨ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯äº‹ä»¶åç§°ï¼Œç¬¬äºŒä¸ªæ˜¯å›è°ƒå‡½æ•°åç§°ã€‚
        once(event, listener) ä¸ºæŒ‡å®šäº‹ä»¶æ³¨å†Œä¸€ä¸ªå•æ¬¡ç›‘å¬å™¨ï¼Œå³ ç›‘å¬å™¨æœ€å¤šåªä¼šè§¦å‘ä¸€æ¬¡ï¼Œè§¦å‘åç«‹åˆ»è§£é™¤è¯¥ç›‘å¬å™¨ã€‚
        emit(event, [arg1], [arg2], [...]) æŒ‰ç›‘å¬å™¨çš„é¡ºåºæ‰§è¡Œæ‰§è¡Œæ¯ä¸ªç›‘å¬å™¨ï¼Œå¦‚æœäº‹ä»¶æœ‰æ³¨å†Œç›‘å¬è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚
        setMaxListeners(n) é»˜è®¤æƒ…å†µä¸‹ï¼Œ EventEmitters å¦‚æœä½ æ·»åŠ çš„ç›‘å¬å™¨è¶…è¿‡ 10 ä¸ªå°±ä¼šè¾“å‡ºè­¦å‘Šä¿¡æ¯ã€‚ setMaxListeners å‡½æ•°ç”¨äºæé«˜ç›‘å¬å™¨çš„é»˜è®¤é™åˆ¶çš„æ•°é‡ã€‚

        æ‰‹åŠ¨å®ç°EventEmitter
    </div>
    <script src="../a.js">


        // ğŸŒ¹2.äº‹ä»¶ç³»ç»Ÿ
        // onã€offã€onceï¼ˆæ‰§è¡Œä¸€æ¬¡åä¸å†æ‰§è¡Œï¼‰ã€filterï¼ˆè¿‡æ»¤ä¼ å…¥çš„äº‹ä»¶ï¼‰
        class Events {
            constructor() {
                this.events = {}
            }
            // äº‹ä»¶ç›‘å¬
            on(evt, callback, ctx) {
                if (!this.events[evt]) {
                    this.events[evt] = []
                }

                this.events[evt].push(callback)

                return this
            }
            // å‘å¸ƒäº‹ä»¶
            emit(evt, ...payload) {
                const callbacks = this.events[evt]

                if (callbacks) {
                    callbacks.forEach((cb) => cb.apply(this, payload))
                }

                return this
            }
            off(evt, handler) {
                // å•¥éƒ½æ²¡ä¼ ï¼Œæ‰€æœ‰çš„äº‹ä»¶éƒ½å–æ¶ˆ
                if (typeof evt === 'undefined') {
                    delete this.events
                } else if (typeof evt === 'string') {
                    // åˆ é™¤æŒ‡å®šäº‹ä»¶çš„å›è°ƒ 
                    if (typeof callback === 'function') {
                        this.events[evt] = this.events[evt].filter((cb) => cb !== callback)
                    } else {
                        // åˆ é™¤æ•´ä¸ªäº‹ä»¶
                        delete this.events[evt]
                    }
                }

                return this
            }

            trigger(evt, args) {
            }

            // åªè¿›è¡Œä¸€æ¬¡çš„äº‹ä»¶è®¢é˜…
            once(evt, callback, ctx) {
                const proxyCallback = (...payload) => {
                    callback.apply(ctx, payload)
                    // å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åå°±åˆ é™¤äº‹ä»¶è®¢é˜…
                    this.off(evt, proxyCallback)
                }

                this.on(evt, proxyCallback, ctx)
            }


            filter() {

            }
        }


    </script>
    <script src="../a.js">
        class EventEmitter {
            constructor() {
                this._max = 10;
                this.eventList = {};
            }
            addListener(event, listener) {
                let exist = this.eventList[event];
                if (exist) {
                    exist.push(listener);
                    if (exist.length >= this._max) {
                        throw Error('è¶…è¿‡ 10 ä¸ª');
                    }
                } else {
                    exist = [listener];
                }
                this.eventList[event] = exist;
            }
            removeListener(event, listener) {
                let listeners = this.eventList[event];
                if (Array.isArray(listeners)) {
                    let index = listeners.indexOf(listener);
                    listeners.splice(index, 1); // åˆ é™¤æ•°ç»„ä¸­çš„ä¸€é¡¹
                }
            }
            once(event, listener) {
                let exist = this.eventList[event] || [];
                let oneFun = (...args) => {
                    listener(...args);
                    this.removeListener(event, oneFun);
                }
                exist.push(oneFun);
                this.eventList[event] = exist;
            }
            emit(event, ...args) {
                let exist = this.eventList[event];
                if (!exist) { return false }
                exist.forEach(it => {
                    it(...args);
                })
            }
        }

        const emitter = new EventEmitter();
        var onceListener = function (args) {
            console.log('æˆ‘åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡', args, this);
        }

        var listener = function (args) {
            console.log('æˆ‘æ˜¯ä¸€ä¸ªlistener', args, this);
        }

        emitter.once('click', onceListener);
        emitter.addListener('click', listener);

        emitter.emit('click', 'å‚æ•°');
        emitter.emit('click');

        emitter.removeListener('click', listener);
        emitter.emit('click');

    </script>
    <script src="../a.js">
        class EventE {
            constructor() {
                // super();
                this.events = {};
                this.max = 10;
            }

            addListener(event, listener) {
                if (!this.events[event]) {
                    this.events[event] = [listener]
                } else {
                    if (this.events[event].length > this.max) {
                        throw Error('max number');
                    }
                    this.events[event].push(listener);
                }
            }

            removeListener(event, listener) {
                if (Array.isArray(this.events[event])) {
                    // åˆ é™¤æŸä¸ªç±»åˆ«çš„äº‹ä»¶
                    if (!listener) {
                        delete this.events[event];
                    }
                    // åˆ é™¤æŸä¸ªå›è°ƒ
                    let index = this.events[event].indexOf(listener);
                    if (index > -1) {
                        this.events[event].splice(index, 1);
                    }
                }
            }

            once(event, listener) {
                let newLis = (...args) => {
                    listener(...args);
                    this.removeListener(event, newLis);
                }
                this.addListener(event, newLis);
            }

            emit(event) {
                [].shift.call(arguments);
                if (this.events[event]) {
                    let staticEvents = [...this.events[event]];
                    staticEvents.forEach((it, index) => it(arguments[index]))
                } else {
                    return false
                }
            }
            // å¦‚æœä½ æ·»åŠ çš„ç›‘å¬å™¨è¶…è¿‡ 10 ä¸ªå°±ä¼šè¾“å‡ºè­¦å‘Šä¿¡æ¯
            setMaxListeners(n) {
                this.max = n;
            }
        }

        const emitter1 = new EventE();
        var onceListener = function (args) {
            console.log('æˆ‘åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡', args, this);
        }

        var listener = function (args) {
            console.log('æˆ‘æ˜¯ä¸€ä¸ªlistener', args, this);
        }

        emitter1.once('click', onceListener);
        emitter1.addListener('click', listener);

        emitter1.emit('click', 'å‚æ•°');
        emitter1.emit('click');

        emitter1.removeListener('click', listener);
        emitter1.emit('click');
    </script>
    <script>
        class EventEmit {
            constructor() {
                this.events = {};
                this._max = 10;
            }
            addListener(event, listener) {
                if (!this.events[event]) {
                    this.events[event] = [listener];
                } else {
                    this.events[event].push(listener);
                    if (this.events[event].length > this._max) {
                        throw Error('max age')
                    }
                }
            }
            removeListener(event, listener) {
                if (Array.isArray(this.events[event])) {
                    if (!listener) {
                        delete this.events[event]
                    } else {
                        let index = this.events[event].indexOf(listener);
                        index > -1 && this.events[event].splice(index, 1);
                    }
                }
            }
            once(event, listener) {
                let self = this;
                const onceFunc = function (...args) {
                    listener(...args);
                    self.removeListener(event, onceFunc);
                }
                this.addListener(event, onceFunc);
            }
            emit(event) {
                [].shift.call(arguments);

                if (this.events[event]) {
                    let events = [...this.events[event]]; // once å¯¼è‡´ events åŠ¨æ€å˜åŒ–é€ æˆå¼‚å¸¸
                    events.forEach((it, index) => it(arguments[index]))
                } else {
                    return false
                }
            }
            setMaxListeners(n) {
                this._max = n;
            }
        }

        const emitter2 = new EventEmit();
        var onceListener = function (args) {
            console.log('æˆ‘åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡', args, this);
        }

        var listener = function (args) {
            console.log('æˆ‘æ˜¯ä¸€ä¸ªlistener', args, this);
        }

        emitter2.once('click', onceListener);
        emitter2.addListener('click', listener);

        emitter2.emit('click', 'å‚æ•°');
        emitter2.emit('click');
        emitter2.emit('click');

        emitter2.removeListener('click', listener);
        emitter2.emit('click');
    </script>
</body>

</html>