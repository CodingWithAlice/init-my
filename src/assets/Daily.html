<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥å¤ç›˜å¿«æ·å…¥å£</title>
    <style>
        .highlight {
            background-color: yellow;
        }

        .red {
            color: red;
        }

        .input {
            height: 24px;
        }

        .act {
            width: 72px;
        }

        .duration {
            font-size: 14px;
            width: 42px;
            display: inline-block;
            text-align: center;
        }

        .att {
            background-color: pink;
            width: 48px;
            display: inline-block;
            text-align: center;
            color: black !important;
        }

        .gap {
            color: blueviolet;
            font-weight: 700;
            font-size: 14px;
        }

        .long {
            width: 250px;
        }

        .short {
            width: 50px;
        }

        p {
            margin: 2px 0;
        }

        .top {
            margin-top: 25px;
        }

        .title {
            font-weight: 500;
        }
        .father {
            display: flex;
            justify-content: space-around;
        }
    </style>
</head>

<body>
    <div class="father">
        <section>
            <!-- <h1>æ¯æ—¥å¤ç›˜</h1> -->
            <h2>ä¸€ã€æ—¶é—´ç»Ÿè®¡</h2>
            <div class="total" id="total"></div>
            <div class="date" id="date"></div>
            <div class="details" id="details"></div>
            <button id="add"> æ·»åŠ ä¸€é¡¹ </button>
        </section>
        <section class="outer">
            <h2>äºŒã€äº‹é¡¹ç»Ÿè®¡</h2>
            <p class="top">å‰ç«¯å­¦ä¹ æ—¶é•¿ï¼š <input class="short"> ğŸ‰ğŸ‰ğŸ‰</p>
            <p class="title">ã€å¤ç›˜ã€‘</p>
            <p>â‘  ç¡çœ  + è¿åŠ¨ï¼š </p>
            <section>
                <textarea class="input long" type="text" name="sports" id="sports" placeholder="è¿åŠ¨æƒ…å†µ"></textarea>
                <textarea class="input long" type="text" name="sleep" id="sleep" placeholder="ç¡çœ æƒ…å†µ"></textarea>
            </section>
            <p>â‘¡ å‰ç«¯ï¼š </p>
            <textarea class="input long" type="text" name="f" id="f" placeholder="å­¦ä¹ æƒ…å†µ"></textarea>
            <p>â‘¢ TED+é˜…è¯»ï¼š </p>
            <section>
                <textarea class="input long" type="text" name="TED" id="TED" placeholder="TED"></textarea>
                <textarea class="input long" type="text" name="read" id="read" placeholder="é˜…è¯»æƒ…å†µ"></textarea>
            </section>
            <p class="title">ã€é—®é¢˜å‘ç°ä¸åˆ†æã€‘</p>
            <textarea class="input long" type="text" name="problem" id="problem" placeholder="é—®é¢˜åˆ†æ"></textarea>
            <p class="title">ã€æ¨èè§£å†³æ–¹æ¡ˆã€‘</p>
            <section>
                <p>æœ‰æ•ˆæ—¶é—´ 50% é—®é¢˜ <input class="short" /></p>
                <textarea class="input long" type="text" name="fix" id="fix" placeholder="é—®é¢˜è§£å†³"></textarea>
            </section>
        </section>
    </div>
    <script>
        /**
         * å‚æ•°ï¼šæ€»åˆ†é’Ÿæ•°
         * è¾“å‡ºï¼šæŒ‰å°æ—¶ åˆ†é’Ÿæ ¼å¼è¾“å‡º
        */
        function transTime(time) {
            let hour = Math.floor(time / 60);
            let min = time % 60;
            // ä¸ºäº†å¤„ç†ç¡çœ 
            hour = hour < 0 ? hour + 24 : hour;
            min = min < 0 ? min + 60 : min;
            if (hour === 0) {
                return `${min}m`
            }
            if (min === 0) {
                return `${hour}h`
            }
            return `${hour}h${min}m`
        }
        /**
         * å‚æ•°ï¼šå¼€å§‹æ—¶é—´ï¼Œç»“æŸæ—¶é—´
         * è¾“å‡ºï¼šæŒ‰å°æ—¶ åˆ†é’Ÿæ ¼å¼è¾“å‡º
        */
        function getDuration(start, end) {
            let min = end.split(':')[1] - start.split(':')[1];
            let hour = end.split(':')[0] - start.split(':')[0];
            return { value: transTime(hour * 60 + min), numValue: hour * 60 + min };
        }

        /**
         * å‚æ•°ï¼šæ—¶é—´å±•ç¤ºç±»å‹
         * è¾“å‡ºï¼šè¾“å‡ºã€å‰ä¸€å¤©ã€‘çš„æ•°æ®
        */
        function getTime(type) {
            let time = new Date();
            switch (type) {
                case 'month':
                    return time.getMonth() + 1;
                    break;
                case 'day':
                    return time.getDate() - 1;
                    break;
                case 'week':
                    const han = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
                    console.log('time.getDay()=', time.getDay());
                    const index = time.getDay() > 1 ? time.getDay() - 2 : time.getDay() + 5;
                    return han[index];
                    break;
            }
        }
        // ç´¯åŠ æ‰€æœ‰æ—¶é—´
        function addTimes(arr) {
            return transTime(arr.reduce((pre, cur) => pre + cur, 0))
        }
        // è®¡ç®—ç¬¬ä¸€è¡Œå±•ç¤ºå€¼
        function getFirstLine(arr) {
            return `æ€»è®¡ï¼š ${addTimes(arr[0])} é˜…è¯»ï¼š${addTimes(arr[1])} ` + `<span class="highlight">å‰ç«¯ï¼š${addTimes(arr[2])}</span>`
        }
        // è®¡ç®—é—´éš”æ—¶é—´
        function getGapTime(id, starts, ends) {
            return getDuration(ends[id - 1], starts[id]);
        }

        // è¾“å…¥å†…å®¹
        function getLines(id) {
            // åˆ›å»º Element
            let newDiv = document.createElement('div');
            newDiv.innerHTML = line;

            // ç»™æ¯ä¸ªæ·»åŠ ç›‘å¬äº‹ä»¶
            const inputs = [...newDiv.childNodes].filter(it => it.nodeName === 'INPUT');
            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    // æ”¹å˜å­¦ä¹ æ´»åŠ¨ç±»å‹
                    if (!!this.list) {
                        const parent = this.parentElement;
                        const inputs = [...parent.childNodes].filter(it => it.nodeName.toLowerCase() === 'input');
                        const duration = [...parent.childNodes].filter(it => it.id === 'duration');
                        const gap = [...parent.childNodes].filter(it => it.id === 'gap');
                        gapElements[id] = gap[0];

                        // å–ä¸¤ä¸ª input time çš„æ—¶é—´è®¡ç®—å­¦ä¹ æ—¶é•¿
                        if (!!inputs[0].value && !!inputs[1].value) {
                            // è®°å½•èµ·å§‹æ—¶é—´
                            startTimes[id] = inputs[0].value;
                            endTimes[id] = inputs[1].value;

                            // è®¡ç®—åŒºé—´
                            let result = getDuration(inputs[0].value, inputs[1].value)
                            duration[0].innerText = result.value;
                            durations[id] = result.numValue;
                            // ä¿å­˜æ€»è®¡æ—¶é—´ - ç¬¬ä¸€è¡Œå±•ç¤ºåˆ·æ–°
                            if (totalException.indexOf(this.value) === -1) { // ä¸è®¡å…¥æ€»æ—¶é•¿
                                totalTimes[id] = result.numValue;
                            }
                            if (this.value === activities.read) {
                                readTime[id] = result.numValue;
                            }
                            if (this.value === activities.f) {
                                fTime[id] = result.numValue;
                            }
                            totalElement.innerHTML = getFirstLine([totalTimes, readTime, fTime]);

                            // è®¡ç®—é—´éš”æ—¶é—´
                            if (id !== 0) {
                                let gapTime = getGapTime(id, startTimes, endTimes);
                                gapElements[id - 1].innerText = gapTime.value;
                                // é«˜äº®æç¤º
                                if (durations[id - 1] < gapTime.numValue) {
                                    console.log(gapElements);

                                    gapElements[id - 1].className += ' att';
                                }
                            }
                        }
                    }
                });
            });

            return newDiv
        }


        // è‡ªå®šä¹‰ æ¯è¡Œè¾“å…¥æ¡†
        const activities = { review: "å¤ç›˜", f: "å‰ç«¯", TED: "TED", read: "é˜…è¯»", sport: "è¿åŠ¨", sleep: "ç¡è§‰", movie: 'ç”µå½±' };
        const totalException = [activities.sleep, activities.movie];
        const line = `
            <input class="input" type="time"/> 
            - <span class="duration" id="duration">----</span> ->
            <input class="input" type="time"/>
            <input class="input act" list="activities"/>
            <datalist id="activities">
                <option value=${activities.review}></option>
                <option value=${activities.f}></option>
                <option value=${activities.TED}></option>
                <option value=${activities.read}></option>
                <option value=${activities.sport}></option>
                <option value=${activities.sleep}></option>
                <option value=${activities.movie}></option>
            </datalist>
            <span class="gap" id="gap"></span>
            `;

        // ç¬¬ä¸€è¡Œ
        let totalTimes = [0], readTime = [0], fTime = [0];
        let startTimes = [0], endTimes = [0], gapElements = [];
        let durations = [];
        const totalElement = document.getElementById('total');
        totalElement.innerHTML = getFirstLine([totalTimes, readTime, fTime]);

        // ç¬¬äºŒè¡Œ
        document.getElementById('date').innerHTML = `<span class="red">${getTime('month')}.${getTime('day')}</span> å‘¨${getTime('week')}`;

        // ç›‘å¬æ·»åŠ æŒ‰é’®
        let button = document.getElementById('add');
        let details = document.getElementById('details');
        let linesId = 0;
        details.appendChild(getLines(linesId));
        button.onclick = function () {
            linesId++;
            details.appendChild(getLines(linesId));
        }

    </script>

</body>

</html>